<div class="container-fluid user-mgmt">
  <div class="table-wrapper">
    <div class="table-title">
      <div class="row">
        <div class="col-xs-6">
          <h2>User Management</h2>
        </div>
        <div class="col-xs-6 text-right">
          <button
            class="btn btn-primary"
            type="button"
            (click)="openCreate($event)"
          >
            <i class="material-icons">&#xE147;</i>
            <span>Add User</span>
          </button>
        </div>
      </div>
    </div>

    <div class="mb-15" style="margin-bottom: 15px; display: flex; gap: 10px">
      <input
        class="form-control"
        style="max-width: 300px"
        [(ngModel)]="filter"
        (keyup.enter)="applyFilter()"
        placeholder="Filter by name or email"
      />
      <button class="btn btn-default" (click)="applyFilter()">Filter</button>
    </div>

    <div *ngIf="loading">Loading...</div>
    <div class="text-danger" *ngIf="error">{{ error }}</div>

    <table
      class="table table-striped table-hover"
      *ngIf="!loading && users.length"
    >
      <thead>
        <tr>
          <th (click)="changeSort('Id')" style="cursor: pointer">
            #
            <i
              *ngIf="sortBy === 'Id'"
              class="material-icons"
              style="font-size: 16px"
            >
              {{ sortOrder === "asc" ? "arrow_upward" : "arrow_downward" }}
            </i>
          </th>
          <th (click)="changeSort('Name')" style="cursor: pointer">
            Name
            <i
              *ngIf="sortBy === 'Name'"
              class="material-icons"
              style="font-size: 16px"
            >
              {{ sortOrder === "asc" ? "arrow_upward" : "arrow_downward" }}
            </i>
          </th>
          <th (click)="changeSort('Email')" style="cursor: pointer">
            Email
            <i
              *ngIf="sortBy === 'Email'"
              class="material-icons"
              style="font-size: 16px"
            >
              {{ sortOrder === "asc" ? "arrow_upward" : "arrow_downward" }}
            </i>
          </th>
          <th (click)="changeSort('Profile')" style="cursor: pointer">
            Perfil
            <i
              *ngIf="sortBy === 'Profile'"
              class="material-icons"
              style="font-size: 16px"
            >
              {{ sortOrder === "asc" ? "arrow_upward" : "arrow_downward" }}
            </i>
          </th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let u of users">
          <td>{{ u.id }}</td>
          <td>{{ u.name }}</td>
          <td>{{ u.email }}</td>
          <td>{{ u.profile }}</td>
          <td>
            <a class="settings" title="Editar" (click)="openEdit(u, $event)">
              <i class="material-icons">&#xE8B8;</i>
            </a>
            <a
              class="delete"
              title="Remover"
              (click)="openConfirm(u, $event)"
              [style.pointer-events]="deletingId === u.id ? 'none' : null"
              [style.opacity]="deletingId === u.id ? 0.5 : null"
            >
              <i class="material-icons">&#xE5C9;</i>
            </a>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="!loading && !users.length">No results.</div>

    <div class="clearfix" *ngIf="!loading && users.length">
      <div class="hint-text">
        Showing <b>{{ users.length }}</b> records (Page {{ pageNumber }})
      </div>
      <ul class="pagination">
        <li class="page-item" [class.disabled]="pageNumber === 1">
          <a (click)="prevPage()" style="cursor: pointer">Previous</a>
        </li>
        <li class="page-item">
          <a style="cursor: default">{{ pageNumber }}</a>
        </li>
        <li class="page-item">
          <a (click)="nextPage()" style="cursor: pointer">Next</a>
        </li>
      </ul>
    </div>
  </div>

  <!-- Modal de confirmação (Angular, sem jQuery) -->
  <div
    *ngIf="confirmModalOpen"
    class="custom-modal-backdrop"
    (click)="closeConfirm()"
  ></div>
  <div
    *ngIf="confirmModalOpen"
    class="custom-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="confirmDeleteTitle"
  >
    <div class="modal-header">
      <h4 id="confirmDeleteTitle" class="modal-title">Confirmar remoção</h4>
      <button
        type="button"
        class="close"
        (click)="closeConfirm()"
        aria-label="Close"
      >
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
    <div class="modal-body">
      Tem a certeza que pretende remover o utilizador
      <b>{{ userPendingDelete?.name }}</b> (ID {{ userPendingDelete?.id }})?
    </div>
    <div class="modal-footer">
      <button class="btn btn-default" type="button" (click)="closeConfirm()">
        Cancelar
      </button>
      <button
        class="btn btn-danger"
        type="button"
        (click)="confirmDelete()"
        [disabled]="deletingId === userPendingDelete?.id"
      >
        {{ deletingId === userPendingDelete?.id ? "A remover..." : "Remover" }}
      </button>
    </div>
  </div>

  <!-- Modal Criar/Editar -->
  <div
    *ngIf="editModalOpen"
    class="custom-modal-backdrop"
    (click)="closeEdit($event)"
  ></div>
  <div
    *ngIf="editModalOpen"
    class="custom-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="editUserTitle"
  >
    <div class="modal-header">
      <h4 id="editUserTitle" class="modal-title">
        {{ isEditing ? "Editar Utilizador" : "Adicionar Utilizador" }}
      </h4>
      <button type="button" class="close" (click)="closeEdit($event)">
        <span aria-hidden="true">&times;</span>
      </button>
    </div>

    <div class="modal-body">
      <form (submit)="$event.preventDefault(); saveUser()">
        <div class="form-group">
          <label>Nome</label>
          <input
            class="form-control"
            [(ngModel)]="editedUser.name"
            name="name"
            required
            [disabled]="saving"
          />
        </div>

        <div class="form-group">
          <label>Email</label>
          <input
            type="email"
            class="form-control"
            [(ngModel)]="editedUser.email"
            name="email"
            required
            [disabled]="saving"
          />
        </div>

        <div class="form-group">
          <label>Password <small *ngIf="isEditing">(opcional)</small></label>
          <input
            type="password"
            class="form-control"
            [(ngModel)]="editedUser.password"
            name="password"
            [required]="!isEditing"
            [disabled]="saving"
            autocomplete="new-password"
          />
        </div>

        <div class="form-group">
          <label>Perfil</label>
          <select
            class="form-control"
            [(ngModel)]="editedUser.profile"
            name="profile"
            [disabled]="saving"
            required
          >
            <option value="CITIZEN">CITIZEN</option>
            <option value="MANAGER">MANAGER</option>
            <option value="ADMIN">ADMIN</option>
          </select>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button
        class="btn btn-default"
        type="button"
        (click)="closeEdit($event)"
        [disabled]="saving"
      >
        Cancelar
      </button>
      <button
        class="btn btn-primary"
        type="button"
        (click)="saveUser()"
        [disabled]="
          saving ||
          !editedUser.name.trim() ||
          !editedUser.email.trim() ||
          (!isEditing && !editedUser.password?.trim())
        "
      >
        {{
          saving
            ? isEditing
              ? "A atualizar..."
              : "A criar..."
            : isEditing
            ? "Guardar"
            : "Criar"
        }}
      </button>
    </div>
  </div>

  <!-- Toast -->
  <div *ngIf="toast.show" class="toast-container">
    <div
      class="alert"
      [ngClass]="{
        'alert-success': toast.type === 'success',
        'alert-danger': toast.type === 'error'
      }"
    >
      {{ toast.message }}
    </div>
  </div>
</div>
