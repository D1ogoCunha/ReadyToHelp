<div class="user-mgmt-page">
  <!-- HEADER: Page title section -->
  <div class="um-header">
    <div class="um-title-wrap">
      <h2 class="um-title">User Management</h2>
    </div>
  </div>

  <!-- TOOLBAR / FILTERS: Search and filter controls -->
  <div class="um-toolbar">
    <div class="filter-group">
      <!-- Search icon and input -->
      <span class="material-icons filter-icon">search</span>
      <input
        class="filter-input"
        [(ngModel)]="filter"
        (keyup.enter)="applyFilter()"
        placeholder="Search..."
      />
    </div>

    <!-- Apply and Reset filter buttons -->
    <div class="d-flex gap-2">
      <button
        class="btn btn-outline-primary btn-sm"
        style="height: 40px; padding: 0 16px"
        (click)="applyFilter()"
      >
        Apply
      </button>
      <button
        class="btn btn-outline-secondary btn-sm"
        style="height: 40px; padding: 0 16px"
        (click)="filter = ''; applyFilter()"
      >
        Reset
      </button>
    </div>
  </div>

  <!-- BODY / TABLE: User list and states -->
  <div class="um-body">
    <!-- Loading state -->
    <div *ngIf="loading" class="loading-state p-4 text-center text-muted">
      <div
        class="spinner-border text-primary spinner-border-sm"
        role="status"
      ></div>
      <span class="ms-2">Loading users...</span>
    </div>

    <!-- Error message -->
    <div class="alert alert-danger m-4 rounded" *ngIf="error">{{ error }}</div>

    <!-- User table -->
    <div class="table-responsive" *ngIf="!loading && users.length">
      <table class="um-table">
        <thead>
          <tr>
            <!-- Sortable columns -->
            <th
              (click)="changeSort('Id')"
              [class.sorted]="sortBy === 'Id'"
              style="width: 60px"
            >
              ID
              <span class="sort-ind" *ngIf="sortBy === 'Id'">{{
                sortOrder === "asc" ? "▲" : "▼"
              }}</span>
            </th>
            <th (click)="changeSort('Name')" [class.sorted]="sortBy === 'Name'">
              Name
              <span class="sort-ind" *ngIf="sortBy === 'Name'">{{
                sortOrder === "asc" ? "▲" : "▼"
              }}</span>
            </th>
            <th
              (click)="changeSort('Email')"
              [class.sorted]="sortBy === 'Email'"
            >
              Email
              <span class="sort-ind" *ngIf="sortBy === 'Email'">{{
                sortOrder === "asc" ? "▲" : "▼"
              }}</span>
            </th>
            <th
              (click)="changeSort('Profile')"
              [class.sorted]="sortBy === 'Profile'"
              style="width: 150px"
            >
              Role
              <span class="sort-ind" *ngIf="sortBy === 'Profile'">{{
                sortOrder === "asc" ? "▲" : "▼"
              }}</span>
            </th>
            <th class="text-right" style="width: 100px">Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- User rows -->
          <tr *ngFor="let u of users">
            <td class="text-muted font-weight-bold">#{{ u.id }}</td>
            <td>
              <!-- User name and avatar -->
              <div class="user-name-cell">
                <div class="avatar-placeholder">
                  {{ u.name.charAt(0) | uppercase }}
                </div>
                <div class="user-name-text">{{ u.name }}</div>
              </div>
            </td>
            <td>
              <span class="email-cell">{{ u.email }}</span>
            </td>
            <td>
              <!-- Profile badge -->
              <span
                class="badge profile-badge"
                [ngClass]="{
                  'badge-admin': u.profile === 'ADMIN',
                  'badge-manager': u.profile === 'MANAGER',
                  'badge-citizen': u.profile === 'CITIZEN'
                }"
              >
                {{ u.profile }}
              </span>
            </td>
            <td class="text-right">
              <!-- Edit and Delete action buttons -->
              <div class="action-group">
                <button class="btn" (click)="openEdit(u, $event)" title="Edit">
                  <span class="material-icons">edit</span>
                </button>
                <button
                  class="btn"
                  (click)="openConfirm(u, $event)"
                  [disabled]="deletingId === u.id"
                  title="Delete"
                >
                  <span class="material-icons">delete_outline</span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Empty state when no users are found -->
    <div *ngIf="!loading && !users.length" class="empty-state py-5 text-center">
      <span
        class="material-icons empty-icon"
        style="font-size: 48px; color: #cbd5e1"
        >group_off</span
      >
      <h5 class="mt-3 text-muted">No users found</h5>
    </div>
  </div>

  <!-- FOOTER: Pagination controls -->
  <div class="um-footer" *ngIf="!loading && users.length">
    <!-- Previous Button -->
    <button
      class="btn btn-nav"
      (click)="prevPage()"
      [disabled]="pageNumber === 1"
    >
      <span class="material-icons" style="font-size: 18px">chevron_left</span>
      Previous
    </button>

    <!-- Page Counter / Info -->
    <div class="page-counter">
      Page <strong>{{ pageNumber }}</strong>
    </div>

    <!-- Next Button -->
    <button class="btn btn-nav" (click)="nextPage()">
      Next
      <span class="material-icons" style="font-size: 18px">chevron_right</span>
    </button>
  </div>

  <!-- MODALS & TOAST: Confirm deletion modal -->
  <div
    *ngIf="confirmModalOpen"
    class="rt-modal-backdrop"
    (click)="closeConfirm()"
  ></div>
  <div *ngIf="confirmModalOpen" class="rt-modal" role="dialog">
    <div class="rt-modal-header">
      <h5 class="m-0">Confirm Deletion</h5>
      <button type="button" class="rt-close" (click)="closeConfirm()">
        &times;
      </button>
    </div>
    <div class="rt-modal-body text-center">
      <p class="mb-1">Are you sure you want to remove:</p>
      <h5 class="text-dark mb-0">{{ userPendingDelete?.name }}</h5>
      <small class="text-muted">ID: {{ userPendingDelete?.id }}</small>
    </div>
    <div class="rt-modal-footer justify-content-center">
      <button class="btn btn-light px-4" (click)="closeConfirm()">
        Cancel
      </button>
      <button class="btn btn-danger px-4" (click)="confirmDelete()">
        Delete
      </button>
    </div>
  </div>

  <!-- MODALS & TOAST: Edit/Create user modal -->
  <div
    *ngIf="editModalOpen"
    class="rt-modal-backdrop"
    (click)="closeEdit($event)"
  ></div>
  <div
    *ngIf="editModalOpen"
    class="rt-modal"
    role="dialog"
    style="width: 500px"
  >
    <div class="rt-modal-header">
      <h5 class="m-0">{{ isEditing ? "Edit User" : "New User" }}</h5>
      <button type="button" class="rt-close" (click)="closeEdit($event)">
        &times;
      </button>
    </div>
    <div class="rt-modal-body">
      <form (submit)="$event.preventDefault(); saveUser()">
        <div class="row g-3">
          <div class="col-md-12">
            <label class="form-label small fw-bold text-secondary">Name</label>
            <input
              class="form-control"
              [(ngModel)]="editedUser.name"
              name="name"
              required
            />
          </div>
          <div class="col-md-12">
            <label class="form-label small fw-bold text-secondary">Email</label>
            <input
              type="email"
              class="form-control"
              [(ngModel)]="editedUser.email"
              name="email"
              required
            />
          </div>
          <div class="col-md-6">
            <label class="form-label small fw-bold text-secondary">Role</label>
            <select
              class="form-select"
              [(ngModel)]="editedUser.profile"
              name="profile"
              required
            >
              <option value="CITIZEN">Citizen</option>
              <option value="MANAGER">Manager</option>
              <option value="ADMIN">Admin</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label small fw-bold text-secondary">
              Password
            </label>
            <input
              type="password"
              class="form-control"
              [(ngModel)]="editedUser.password"
              name="password"
              autocomplete="new-password"
            />
          </div>
        </div>
      </form>
    </div>
    <div class="rt-modal-footer">
      <button class="btn btn-light px-4" (click)="closeEdit($event)">
        Cancel
      </button>
      <button
        class="btn btn-primary px-4"
        (click)="saveUser()"
        [disabled]="
          !editedUser.name.trim() ||
          !editedUser.email.trim() ||
          (!isEditing && !editedUser.password?.trim())
        "
      >
        {{ isEditing ? "Save" : "Create" }}
      </button>
    </div>
  </div>
  <!-- Toast notification for success/error messages -->
  <div *ngIf="toast.show" class="rt-toast-container">
    <div
      class="alert"
      [ngClass]="{
        'alert-success': toast.type === 'success',
        'alert-danger': toast.type === 'error'
      }"
    >
      {{ toast.message }}
    </div>
  </div>

  <!-- FAB Add User: Floating action button to add new user -->
  <button
    class="fab-add-user"
    type="button"
    aria-label="Add user"
    (click)="openCreate($event)"
  >
    <span class="material-icons">add</span>
  </button>
  
  <!-- Legal footer component -->
  <app-legal-footer></app-legal-footer>
</div>