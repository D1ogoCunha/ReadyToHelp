# -------------------------------
# ReadyToHelp - Pipeline Configuration
# -------------------------------

stages:
  - setup
  - build
  - test
  - deploy

variables:
  POSTGRES_USER: readytohelp
  POSTGRES_PASSWORD: readytohelppwd
  POSTGRES_DB: readytohelp_db
  POSTGRES_HOST: postgres
  SOLUTION_PATH: API/ReadyToHelpAPI.sln
  PROJECT_PATH: API/ReadyToHelpAPI/ReadyToHelpAPI.csproj
  WEB_PATH: WEB/readytohelp
  MOBILE_PATH: MOBILE/
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"

image: mcr.microsoft.com/dotnet/sdk:8.0

before_script:
  - export PATH="$PATH:/root/.dotnet/tools"

setup-database:
  stage: setup
  services:
    - name: postgis/postgis:15-3.3
      alias: postgres
  script:
    - apt-get update && apt-get install -y curl
    - curl -o wait-for-it.sh https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh
    - chmod +x wait-for-it.sh
    - ./wait-for-it.sh postgres:5432 -- echo "PostgreSQL pronto"

build:
  stage: build
  only:
    - branches
    - merge_requests
  script:
    - echo "Building ReadyToHelp API..."
    - dotnet restore "$SOLUTION_PATH"
    - dotnet build "$SOLUTION_PATH" --configuration Release --no-restore

unit-tests:
  stage: test
  variables:
    ASPNETCORE_ENVIRONMENT: Testing
  script:
    - dotnet test "$SOLUTION_PATH" --filter "Category=Unit" --logger "trx;LogFileName=UnitTestResults.trx" /p:CollectCoverage=true /p:CoverletOutputFormat=opencover /p:CoverletOutput=./TestResults/coverage.xml "/p:ExcludeByFile=**/API/ReadyToHelpAPI/Migrations/**"
  artifacts:
    paths:
      - UnitTestResults.trx
      - TestResults/coverage.xml
    expire_in: 1 week
  only:
    - branches
    - merge_requests

integration-tests:
  stage: test
  services:
    - name: postgis/postgis:15-3.3
      alias: postgres
  variables:
    ASPNETCORE_ENVIRONMENT: Testing
    POSTGRES_PORT: 5432
  script:
    - apt-get update && apt-get install -y curl postgresql-client
    - curl -o wait-for-it.sh https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh
    - chmod +x wait-for-it.sh
    - ./wait-for-it.sh postgres:5432 -- echo "PostgreSQL is up"
    - PGPASSWORD="$POSTGRES_PASSWORD" psql -h "$POSTGRES_HOST" -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "CREATE EXTENSION IF NOT EXISTS postgis;"
    - dotnet restore "$SOLUTION_PATH"
    - dotnet new tool-manifest
    - dotnet tool install dotnet-ef --version 8.0.5
    - dotnet tool run dotnet-ef database update --project "$PROJECT_PATH" --startup-project "$PROJECT_PATH"
    - dotnet test "$SOLUTION_PATH" --filter "Category=Integration" --logger "trx;LogFileName=IntegrationTests.trx" /p:CollectCoverage=true /p:CoverletOutput=./TestResults/ /p:CoverletOutputFormat=opencover "/p:ExcludeByFile=**/API/ReadyToHelpAPI/Migrations/**"
  artifacts:
    paths:
      - IntegrationTests.trx
      - TestResults/
  only:
    - merge_requests

# =========================================================
# FRONTEND WEB (Angular + Cypress)
# =========================================================
web-test-system:
  stage: test
  image: cypress/browsers:node-20.9.0-chrome-118.0.5993.88-1-ff-118.0.2-edge-118.0.2088.46-1
  script:
    - apt-get update || true
    - apt-get install -y curl || true
    - echo "Testing Web Frontend (System/E2E)..."
    - cd "$WEB_PATH"
    - npm ci
    - npx ng serve --host 0.0.0.0 --port 4200 &
    - npx wait-on http://localhost:4200
    - npx cypress run --browser chrome
  artifacts:
    when: always
    paths:
      - "$WEB_PATH/cypress/videos/**/*.mp4"
      - "$WEB_PATH/cypress/screenshots/**/*.png"
    expire_in: 1 week
  only:
    - merge_requests
# =========================================================
# MOBILE (Android) - Runner Linux Self-Hosted
# =========================================================
.android-test-system:
  stage: test
  image: reactnativecommunity/react-native-android:latest

  tags:
    - linux

  before_script:
    - echo "Preparing Android environment..."
    - apt-get update && apt-get install -y libpulse0
    - yes | sdkmanager --licenses > /dev/null || true
    - echo "Downloading System Image..."
    - sdkmanager "system-images;android-34;google_apis;x86_64" "platform-tools" "platforms;android-34" > /dev/null
    - echo "no" | avdmanager create avd -n test_device -k "system-images;android-34;google_apis;x86_64" --force

  script:
    - echo "Starting Emulator..."
    - $ANDROID_HOME/emulator/emulator -avd test_device -no-audio -no-window -gpu swiftshader_indirect -no-snapshot -no-boot-anim &
    - echo "Waiting for device to boot..."
    - adb wait-for-device
    - adb shell input keyevent 82

    - echo "Starting tests..."
    - cd "$MOBILE_PATH"
    - chmod +x gradlew

    - ./gradlew clean
    - ./gradlew :app:gerarRelatorioCoverage

  artifacts:
    when: always
    paths:
      - "$MOBILE_PATH/app/build/reports/jacoco/gerarRelatorioCoverage/html/"
      - "$MOBILE_PATH/app/build/reports/androidTests/connected/"
    expire_in: 1 week
  only:
    - merge_requests
