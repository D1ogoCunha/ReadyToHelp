# -------------------------------
# ReadyToHelp - CI Pipeline
# -------------------------------

stages:
  - setup
  - build
  - test
  - deploy

image: mcr.microsoft.com/dotnet/sdk:8.0

variables:
  POSTGRES_USER: readytohelp
  POSTGRES_PASSWORD: readytohelppwd
  POSTGRES_DB: readytohelp_db
  POSTGRES_HOST: postgres

setup-database:
  stage: setup
  script:
    - echo "PostgreSQL pronto"

build:
  stage: build
  script:
    - echo "Building ReadyToHelp API..."
    - dotnet restore ReadyToHelpAPI.sln
    - dotnet build ReadyToHelpAPI.sln --configuration Release --no-restore
  artifacts:
    expire_in: 1 day
  only:
    - main
    - merge_requests

test:
  stage: test
  dependencies:
    - setup-database
  services:
    - name: postgres:14
      alias: postgres
  script:
    - ./wait-for-it.sh postgres:5432 -- echo "PostgreSQL is ready"
    - echo "Running unit and integration tests..."
    - dotnet test ReadyToHelpAPI.sln --configuration Release --no-build --verbosity normal
  artifacts:
    reports:
      junit: test-results.xml
    expire_in: 1 week
  only:
    - main
    - merge_requests

