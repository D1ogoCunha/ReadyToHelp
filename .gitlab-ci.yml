# -------------------------------
# ReadyToHelp - CI Pipeline
# -------------------------------

stages:
  - setup
  - build
  - lint
  - test
  - deploy

image: mcr.microsoft.com/dotnet/sdk:8.0

variables:
  POSTGRES_USER: readytohelp
  POSTGRES_PASSWORD: readytohelppwd
  POSTGRES_DB: readytohelp_db
  POSTGRES_HOST: postgres

before_script:
  - apt-get update && apt-get install -y curl
  - curl -o wait-for-it.sh https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh
  - chmod +x wait-for-it.sh
  - export PATH="$PATH:/root/.dotnet/tools"

setup-database:
  stage: setup
  services:
    - name: postgis/postgis:15-3.3
      alias: postgres
  script:
    - ./wait-for-it.sh postgres:5432 -- echo "PostgreSQL pronto"

build:
  stage: build
  only:
    - branches
    - merge_requests
  script:
    - echo "Building ReadyToHelp API..."
    - dotnet restore ReadyToHelpAPI.sln
    - dotnet build ReadyToHelpAPI.sln --configuration Release --no-restore

lint:
  stage: lint
  script:
    - dotnet tool install -g dotnet-format
    - $HOME/.dotnet/tools/dotnet-format ReadyToHelpAPI.sln --check
  allow_failure: true
  only:
    - branches
    - merge_requests

unit-tests:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  variables:
    ASPNETCORE_ENVIRONMENT: Testing
  script:
    - dotnet test ReadyToHelpAPI.sln --filter "Category=Unit" --logger:"trx;LogFileName=UnitTestResults.trx"
  artifacts:
    paths:
      - UnitTestResults.trx
    expire_in: 1 week
  only:
    - branches
    - merge_requests

integration-tests:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  services:
    - name: postgis/postgis:15-3.3
      alias: postgres
  variables:
    POSTGRES_USER: readytohelp
    POSTGRES_PASSWORD: readytohelppwd
    POSTGRES_DB: readytohelp_db
    POSTGRES_HOST: postgres
    POSTGRES_PORT: 5432
    ASPNETCORE_ENVIRONMENT: Testing
  script:
    - ./wait-for-it.sh postgres:5432 -- echo "PostgreSQL is up"
    - dotnet test ReadyToHelpAPI.sln --filter "Category=Integration" --collect:"XPlat Code Coverage" --logger:"trx;LogFileName=IntegrationTestResults.trx"
  artifacts:
    paths:
      - IntegrationTestResults.trx
    expire_in: 1 week
  only:
    - merge_requests

deploy:
  stage: deploy
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - echo "Deploying to Azure..."
    - curl -sL https://aka.ms/InstallAzureCLIDeb | bash
    - az login --service-principal --username $AZURE_CLIENT_ID --password $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
    - az acr login --name readytohelpcr
    - docker build -t readytohelpcr.azurecr.io/lds_25_26-app:latest ./ReadyToHelpAPI
    - docker push readytohelpcr.azurecr.io/lds_25_26-app:latest
    - az container delete --resource-group ReadyToHelp --name r2h-app --yes || true
    - az container create --resource-group ReadyToHelp --name r2h-app --image readytohelpcr.azurecr.io/lds_25_26-app:latest --os-type Linux --cpu 1 --memory 2 --ports 8080 --ip-address Public --environment-variables ASPNETCORE_ENVIRONMENT=Development POSTGRES_HOST=20.250.214.63 POSTGRES_USERNAME=readytohelp POSTGRES_PASSWORD=readytohelppwd --registry-username readytohelpCR --registry-password $ACR_PASSWORD --restart-policy Always
  only:
    - main
    - dev
  environment:
    name: production