# -------------------------------------------
# ReadyToHelp - Optimized CI Pipeline
# -------------------------------------------

stages:
  - build
  - lint
  - test

image: mcr.microsoft.com/dotnet/sdk:8.0

variables:
  POSTGRES_USER: readytohelp
  POSTGRES_PASSWORD: readytohelppwd
  POSTGRES_DB: readytohelp_db
  POSTGRES_HOST: postgres
  ASPNETCORE_ENVIRONMENT: Testing

before_script:
  - apt-get update && apt-get install -y curl
  - curl -o wait-for-it.sh https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh
  - chmod +x wait-for-it.sh
  - export PATH="$PATH:/root/.dotnet/tools"

build:
  stage: build
  script:
    - dotnet restore ReadyToHelpAPI.sln
    - dotnet build ReadyToHelpAPI.sln --configuration Release --no-restore
  only:
    - branches
    - merge_requests

lint:
  stage: lint
  script:
    - dotnet tool install -g dotnet-format
    - $HOME/.dotnet/tools/dotnet-format ReadyToHelpAPI.sln --check
  allow_failure: true
  only:
    - branches
    - merge_requests

unit-tests:
  stage: test
  script:
    - dotnet test ReadyToHelpAPI.sln \
        --filter "Category=Unit" \
        --logger:"trx;LogFileName=UnitTestResults.trx" \
        /p:CollectCoverage=true \
        /p:CoverletOutputFormat=opencover \
        /p:CoverletOutput=./TestResults/coverage.xml \
        "/p:ExcludeByFile=**/ReadyToHelpAPI/Migrations/**"
  artifacts:
    paths:
      - UnitTestResults.trx
      - TestResults/
    expire_in: 1 week
  only:
    - branches
    - merge_requests

integration-tests:
  stage: test
  services:
    - name: postgis/postgis:15-3.3
      alias: postgres
  script:
    - ./wait-for-it.sh postgres:5432 -- echo "PostgreSQL is up"
    - dotnet test ReadyToHelpAPI.sln \
        --filter "Category=Integration" \
        --logger:"trx;LogFileName=IntegrationTestResults.trx" \
        /p:CollectCoverage=true \
        /p:CoverletOutputFormat=opencover \
        /p:CoverletOutput=./TestResults/coverage.xml \
        "/p:ExcludeByFile=**/ReadyToHelpAPI/Migrations/**"
  artifacts:
    paths:
      - IntegrationTestResults.trx
      - TestResults/
    expire_in: 1 week
  only:
    - merge_requests
